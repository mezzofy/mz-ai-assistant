# MEMORY.md — Data Persistence & Knowledge Layer

**PostgreSQL database, sales CRM, conversation history, knowledge base, and file storage.**

---

## Overview

The persistence layer powers everything from chat history to the sales pipeline to generated document storage.

```
Data Layer Components:
├── PostgreSQL           # Primary database (users, conversations, CRM, scheduled jobs, webhooks, audit)
├── /knowledge           # Mezzofy product data, templates, brand assets
├── /data                # Generated artifacts (EBS or S3)
├── Redis                # Celery task broker, rate limiting, caching, WS pub/sub
└── /server/app/context  # Session + artifact management code
```

---

## PostgreSQL Database

All tables are created by `scripts/migrate.py`. See [INFRASTRUCTURE.md](INFRASTRUCTURE.md) for full schema.

### Core Tables

| Table | Purpose | Used By |
|-------|---------|---------|
| `users` | Team member accounts, departments, roles | Auth, RBAC |
| `conversations` | Chat history (user + assistant messages) | Session Manager |
| `sales_leads` | CRM / sales pipeline | Sales Agent, CRM tools |
| `artifacts` | Generated files metadata (path, type, owner) | Artifact Manager |
| `audit_log` | Every significant action recorded | Security, Management |
| `llm_usage` | Token consumption per model/dept/user | Cost tracking, dashboards |
| `email_log` | All Outlook emails sent (recipient, subject, status) | Compliance, audit |
| `scheduled_jobs` | User-created recurring tasks (cron-based) | Celery Beat, Scheduler API |
| `webhook_events` | Incoming webhook event log + processing status | Webhook handler, audit |

---

## Session Manager (`app/context/session_manager.py`)

Manages conversation history per user in PostgreSQL.

### Key Methods

#### `add_interaction(user_id, session_id, input_data, tool_results, response)`

Stores both user message and assistant response in the `conversations` table with metadata (tools used, agent used).

#### `get_history(user_id, session_id, limit=20)`

Retrieves recent conversation messages in chronological order. Fed into the LLM as context for multi-turn conversations.

#### `list_sessions(user_id)`

Returns all chat sessions for a user, ordered by last activity. Drives the ChatHistoryScreen in the mobile app.

### Session Lifecycle

```
User opens app → new session (or resumes latest)
    │
    ├── Each message: INSERT into conversations (user + assistant)
    ├── Context: last 20 messages loaded for each LLM call
    └── Session persists indefinitely (queryable via /chat/history)
```

---

## Artifact Manager (`app/context/artifact_manager.py`)

Manages all generated files (PDFs, PPTX, CSV, DOCX, etc.).

### Storage

| Environment | Storage | Path |
|------------|---------|------|
| Default | EBS volume | `/data/artifacts/{type}/{filename}` |
| Production (scaled) | S3 bucket | `s3://mezzofy-ai-artifacts/{type}/{filename}` |

### Artifact Types

| Type | Subdirectory | Examples |
|------|-------------|---------|
| `pdf` | `/documents` | Financial statements, playbooks, reports |
| `pptx` | `/presentations` | Sales pitch decks |
| `csv` | `/exports` | Lead lists, data exports |
| `docx` | `/documents` | Website copy, proposals |
| `upload` | `/uploads` | User-uploaded files for processing |

### Key Methods

#### `store(user_id, session_id, file_path, file_type, name)`

Copies file to storage, records in `artifacts` table, returns download URL.

#### `get_artifact(file_id, requesting_user_id)`

Retrieves artifact if the requesting user owns it or has permission (management can view all).

#### `list_artifacts(user_id)`

Lists all files generated by a user, ordered by creation date. Drives the FilesScreen in the mobile app.

---

## Sales Lead CRM

The `sales_leads` table acts as a lightweight CRM, managed by the Sales Agent via `crm_ops.py` tools.

### Lead Lifecycle

```
New lead discovered (LinkedIn, web scrape, manual entry)
    │ status: "new"
    ▼
Contact email sent by Sales Agent
    │ status: "contacted"
    ▼
Follow-up and qualification
    │ status: "qualified"
    ▼
Proposal sent
    │ status: "proposal"
    ▼
Won or Lost
    │ status: "closed_won" or "closed_lost"
```

### Data Fields

```python
{
    "id": "UUID",
    "company_name": "ABC Restaurant Group",
    "contact_name": "John Tan",
    "contact_email": "john@abcrestaurant.sg",
    "contact_phone": "+65 9xxx xxxx",
    "industry": "F&B",
    "location": "Singapore",
    "source": "linkedin",             # linkedin | website | referral | event
    "status": "contacted",            # new | contacted | qualified | proposal | closed_won | closed_lost
    "assigned_to": "user_123",
    "notes": "Interested in loyalty program",
    "created_at": "2025-12-01T10:00:00Z",
    "last_contacted": "2025-12-03T14:30:00Z",
    "follow_up_date": "2025-12-10T09:00:00Z"
}
```

### Access Control

- Sales reps see only their own leads (`assigned_to = current_user`)
- Sales managers see all leads
- Management gets read-only pipeline summaries

---

## Mezzofy Knowledge Base (`/knowledge`)

Static company data loaded by the `knowledge_ops.py` tool.

```
/server/knowledge
├── /product_data
│   ├── products.json           # Full product catalog
│   ├── pricing.yaml            # Pricing tiers and plans
│   └── features.yaml           # Feature specifications
│
├── /templates
│   ├── /emails                 # HTML email templates
│   │   ├── intro.html          # Cold outreach
│   │   ├── followup.html       # Follow-up
│   │   └── proposal.html       # Proposal email
│   ├── /pdf                    # PDF HTML templates (for WeasyPrint)
│   │   ├── financial_statement.html
│   │   ├── playbook.html
│   │   └── report.html
│   └── /pptx                   # PPTX templates (python-pptx)
│       ├── sales_deck.pptx
│       └── overview.pptx
│
├── /brand
│   ├── brand_guidelines.md     # Tone of voice, dos and don'ts
│   ├── color_palette.yaml      # Brand colors
│   └── /logos                  # Logo files (PNG, SVG)
│
└── /playbooks                  # Existing playbook content for reference
```

### How Agents Use It

- **Sales Agent** → `get_products()` for pitch decks, `get_template("pptx", "sales_deck")` for slide template
- **Marketing Agent** → `get_brand_guidelines()` for tone, `get_feature_specs()` for accuracy
- **Finance Agent** → `get_template("pdf", "financial_statement")` for branded reports

### Keeping It Current

Product data and templates should be updated when Mezzofy releases new features or changes pricing. The knowledge base is stored in Git alongside the server code, so updates are deployed with `scripts/deploy.sh`.

---

## LLM Usage Tracking

Every API call to Claude or Kimi is logged:

```sql
INSERT INTO llm_usage (model, department, user_id, input_tokens, output_tokens)
VALUES ('claude-sonnet-4-5-20250929', 'sales', 'user_123', 1250, 800);
```

This data powers the Management Agent's cost dashboards and helps Mezzofy monitor LLM spend per department.

---

## Redis

Used for:

- **Celery task broker** — routes background tasks from FastAPI to Celery workers
- **Celery result backend** — stores task completion status and results
- **Rate limiting** — per-user request counts with TTL
- **Session caching** — hot session data to reduce DB reads
- **WebSocket pub/sub** — push Celery task progress updates to mobile WebSocket connections

Configuration:
```yaml
# Runs on the same EC2 instance
redis:
  host: "localhost"
  port: 6379
  db_broker: 0       # Celery broker
  db_results: 1      # Celery results
  db_cache: 2        # Rate limiting + session cache
```

---

## Scheduled Jobs

The `scheduled_jobs` table stores user-created recurring tasks. Celery Beat checks this table and fires jobs on their cron schedule.

### Data Fields

```python
{
    "id": "UUID",
    "user_id": "UUID",
    "name": "Weekly KPI Report",
    "agent": "management",
    "message": "Generate weekly KPI dashboard across all departments",
    "schedule": "0 9 * * 1",              # Cron: Monday 9AM SGT
    "deliver_to": {
        "teams_channel": "management",     # Post to MS Teams
        "email": ["ceo@mezzofy.com"]       # Also send via Outlook
    },
    "is_active": true,
    "last_run": "2026-02-24T09:00:00Z",
    "next_run": "2026-03-03T09:00:00Z"
}
```

### Built-in Scheduled Jobs (from `beat_schedule.py`)

| Job | Schedule | Agent | Delivery |
|-----|----------|-------|----------|
| Weekly KPI Report | Monday 9AM | Management | Teams #management + executive emails |
| Monthly Financial Summary | 1st of month 8AM | Finance | Teams #finance + CFO email |
| Daily Stale Lead Follow-Up | Weekdays 10AM | Sales | Teams #sales |
| Weekly Support Summary | Friday 5PM | Support | Teams #support + manager email |

Users with `scheduler_manage` permission can create custom recurring jobs via `POST /scheduler/jobs`.

### Access Control

- Users can only create jobs for their own department
- Managers can view/delete jobs for their department
- Executives/admins can manage all jobs
- All job executions logged in `audit_log` with `source = 'scheduler'`

---

## Webhook Events

The `webhook_events` table logs all incoming webhook events and their processing status.

### Event Lifecycle

```
External service → POST /webhooks/{source}
    │ status: "received"
    ▼
Celery worker picks up task
    │ status: "processing"
    ▼
Agent executes workflow
    │ status: "completed" (or "failed")
    └── Result stored in webhook_events.result
```

### Supported Sources

| Source | Events | Processing |
|--------|--------|-----------|
| Mezzofy product | `customer_signed_up`, `customer_churned`, `order_completed`, `support_ticket_created` | Sales/Support Agent → CRM + Teams notification |
| MS Teams | `@mention` in channel | Route to relevant agent → reply in Teams |
| Custom (Zapier, GitHub, etc.) | Configurable | Route to specified agent |

### Webhook → Agent Routing

```python
WEBHOOK_AGENT_MAP = {
    "customer_signed_up": "sales",       # Add to CRM, notify sales
    "customer_churned": "management",    # Alert management
    "order_completed": "finance",        # Log revenue event
    "support_ticket_created": "support", # Categorize + alert
    "feature_released": "marketing",     # Prepare content
}
```

---

## Backup Strategy

| Data | Backup Method | Frequency |
|------|--------------|-----------|
| PostgreSQL | `pg_dump` to S3 | Daily |
| Knowledge base | Git repository | On every deploy |
| Generated artifacts | EBS snapshots (or S3 versioning) | Weekly |
| `.env` / secrets | AWS Secrets Manager (recommended) | On change |
